var _                = require( 'underscore' ),
	fs               = require( 'fs' ),
    config           = require( 'lib/config' ),
	path             = require( 'path' ),
	mongoose         = require( 'mongoose' ),
	querystringUtils = require( 'querystring' ),
	crudAdapter      = require( 'lib/crudAdapter' ),
	Logger           = require( 'lib/logger' ),
	logger           = new Logger( __filename ),
	urljoin          = require( 'url-join' ),
	uri              = config.db.uri,
	options          = config.db.options;    

var connectDb = function(){
    mongoose.connection.on( 'error',         logger.error);
    mongoose.connection.on( 'disconnected',  function(){logger.info('{0} has been disconnected, retry to connect database', uri); connectDb();});
    mongoose.connection.on( 'connecting',    function(){logger.info('connecting to {0}', uri );});
    mongoose.connection.on( 'connected',     function(){logger.info('{0} has been connected', uri );});
    mongoose.connection.on( 'disconnecting', function(){logger.info('disconnecting from {0}', uri );});
    mongoose.connection.on( 'open',          function(){logger.info('{0} has been opened', uri );});

    mongoose.connect( uri, options );
};

var bindCrud = function( app ){

    connectDb();

    require('express-crud')(app);
	
	var dir = __dirname + '/' + 'models';
	
	fs.readdirSync( dir ).forEach( function( file ){
		
		if( path.extname( file ) !== '.js' ) { return; }

		var modelName = path.basename( file, '.js' );
		
		var url = urljoin(config.crudApiRoot, modelName);

		logger.info( 'support {0}\'s crud api at {1}', modelName, url );

		app.crud( url, crudAdapter( modelName ));
	});
};

module.exports = bindCrud;