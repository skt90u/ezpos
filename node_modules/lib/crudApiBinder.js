var _                = require( 'underscore' ),
	fs               = require( 'fs' ),
    config           = require( 'lib/config' ),
	path             = require( 'path' ),
	mongoose         = require( 'mongoose' ),
	querystringUtils = require( 'querystring' ),
	crudApiFactory   = require( './crudApiFactory' ),
	Logger           = require( 'lib/logger' ),
	logger           = new Logger( 'crudApiBinder' );

var connectDb = function(){

    var options = { server: { socketOptions: {keepAlive: 1} } };

    mongoose.connection.on('error',         logger.error);
    mongoose.connection.on('disconnected',  function(){logger.info('{0} has been disconnected, retry to connect database', config.db); connectDb();});
    mongoose.connection.on('connecting',    function(){logger.info('connecting to {0}', config.db );});
    mongoose.connection.on('connected',     function(){logger.info('{0} has been connected', config.db );});
    mongoose.connection.on('disconnecting', function(){logger.info('disconnecting from {0}', config.db );});
    mongoose.connection.on('open',          function(){logger.info('{0} has been opened', config.db );});

    mongoose.connect(config.db, options);
};

var bindCrud = function( app ){

    connectDb();

    require('express-crud')(app);
	
	var schemaDir = __dirname + '/' + 'schema';
	
	logger.info('read schema dir: {0}', schemaDir);

	fs.readdirSync( schemaDir ).forEach( function( file ){
		if( path.extname( file ) !== '.js' ) {
			return;
		}
		
		var modelName = path.basename( file, '.js' );
		var crupApi = crudApiFactory( modelName );
		logger.info( 'bind crudApi for ' + modelName );
		app.crud( modelName, crupApi);
	});
};

module.exports = bindCrud;
